name: Unified CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
    - 'down/**'
    - 'frontend/**'
    - 'terraform/**'
    - '.github/workflows/unified-deploy.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      action:
        description: 'Terraform action'
        required: true
        default: 'apply'
        type: choice
        options:
        - plan
        - apply
        - destroy
      deploy_static:
        description: 'Deploy static files'
        required: false
        default: true
        type: boolean
      deploy_ecs:
        description: 'Deploy to ECS'
        required: false
        default: true
        type: boolean

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: game-server
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER || 'game-cluster' }}
  ECS_SERVICE: ${{ secrets.ECS_SERVICE || 'game-service' }}
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TF_VERSION: '1.5.0'

jobs:
  # 1. 빌드 및 테스트
  build-and-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build with Gradle
      run: |
        cd down
        chmod +x gradlew
        ./gradlew build -x test
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: down/build/libs/

  # 2. Docker 이미지 빌드 및 푸시
  docker-build:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: down/build/libs/
        
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push Docker image
      run: |
        cd down
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  # 3. 정적 파일 배포 (S3 + CloudFront)

  # 4. 정적 파일 배포 (S3 + CloudFront)
  deploy-static:
    needs: docker-build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_static == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Build React app
      run: |
        cd frontend
        npm run build
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Get S3 bucket name
      id: get-bucket
      run: |
        # GitHub Secrets에서 S3 버킷 이름 가져오기
        BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
        
        if [ -z "$BUCKET_NAME" ]; then
          echo "S3 bucket name not found in secrets. Skipping static deployment."
          echo "skip_deploy=true" >> $GITHUB_OUTPUT
        else
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
        fi
        
    - name: Deploy to S3
      if: steps.get-bucket.outputs.skip_deploy != 'true'
      run: |
        # S3에 파일 업로드
        aws s3 sync frontend/build/ s3://${{ steps.get-bucket.outputs.bucket_name }}/ \
          --delete \
          --cache-control "max-age=31536000,public" \
          --exclude "*.html" \
          --exclude "*.json"
          
        # HTML 파일은 캐시하지 않음
        aws s3 sync frontend/build/ s3://${{ steps.get-bucket.outputs.bucket_name }}/ \
          --delete \
          --cache-control "no-cache,no-store,must-revalidate" \
          --include "*.html" \
          --include "*.json"
          
        echo "Static files deployed to s3://${{ steps.get-bucket.outputs.bucket_name }}"
        
    - name: Invalidate CloudFront cache
      if: steps.get-bucket.outputs.skip_deploy != 'true'
      run: |
        # CloudFront 배포 ID 가져오기
        DISTRIBUTION_ID=$(aws cloudfront list-distributions \
          --query 'DistributionList.Items[?Comment==`production-cloudfront`].Id' \
          --output text)
          
        if [ ! -z "$DISTRIBUTION_ID" ]; then
          # CloudFront 캐시 무효화
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*"
          echo "CloudFront cache invalidated for distribution: $DISTRIBUTION_ID"
        else
          echo "CloudFront distribution not found"
        fi

  # 5. ECS 배포
  deploy-ecs:
    needs: [docker-build]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_ecs == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Pull and tag image for ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # GitHub Container Registry에서 이미지 가져오기
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        # ECR용으로 태그 변경
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        # ECR에 푸시
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
        
    - name: Update ECS service
      run: |
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --force-new-deployment
          
    - name: Wait for deployment
      run: |
        aws ecs wait services-stable \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE

  # 6. 배포 완료 알림
  deployment-summary:
    needs: [deploy-static, deploy-ecs]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## 🚀 배포 완료!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### 🔄 배포된 서비스:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ 백엔드 API (Docker Image)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ 프론트엔드 (S3 + CloudFront)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ ECS 서비스 업데이트" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📝 다음 단계:" >> $GITHUB_STEP_SUMMARY
        echo "1. 애플리케이션 상태 확인" >> $GITHUB_STEP_SUMMARY
        echo "2. 모니터링 설정 확인" >> $GITHUB_STEP_SUMMARY
        echo "3. 로그 확인" >> $GITHUB_STEP_SUMMARY
